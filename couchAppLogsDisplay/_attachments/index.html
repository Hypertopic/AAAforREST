<html>
	<head>
	
		<!-- LIBS -->
		<script src="./js/d3.min.js"></script>
		<script src="./js/moment.min.js"></script>
		<script src="./js/jquery-2.1.3.min.js"></script>
		<script src="./js/graph.js"></script>
		<script src="./js/utils.js"></script>
		
		<!-- CSS -->
		<link rel="stylesheet" href="./css/bootstrap.min.css"/>
		<link rel="stylesheet" href="./css/bootstrap-theme.min.css"/>
		<link rel="stylesheet" href="./css/style.css"/>
		<link rel="stylesheet" href="./css/basic.css"/>
		<link rel="stylesheet" href="./css/graph.css"/>
	</head>
	
	<body>
		<script>
			var params = getUrlRequestParams();
			
			/**
				Creation du nuage de tags :
			**/
			$.getJSON("./_view/countByIPDateNoGet?group=true", function(result){
				var ipList = {};
				var ipRegex = /[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/;
				result.rows.forEach(
				function(item){
					//Permet de récupèrer uniquement le login (sans l'IP) :
					var itemKey = item.key[0].split('@')[0];
					
					//Filtre les IP, et si le filter===true, supprime anony* et alice
					//Deux contributeurs qui "flood" le nuage de tags à cause de l'écart de contribution
					if(!itemKey.match(ipRegex) && (typeof(params.filter) === "undefined" || params.filter === false || !itemKey.startsWith('anonym') && itemKey !== "alice")) {
						if(typeof(ipList[itemKey]) === "undefined") {
							ipList[itemKey] = [];
						}
						ipList[itemKey].push({date:item.key[1], value: item.value});
					}
				});
				createTagCloud('#tagCloud', ipList);
			});
			
			/**
				Creation de la liste des URL navigable :
			**/
			$.getJSON("./_view/countByUrl?group=true&group_level=1", function(result){
				result.rows.sort(function(a,b){return b.value - a.value;});
				result.rows.forEach(
				function(item){
					$("#url").append('<a href="./url.html?level=1&url1='+encodeURIComponent(item.key[0])+'" class="list-group-item"><span class="badge">'+item.value+'</span>'+item.key[0]+'</a>');
				});
			});
		</script>
		<nav class="navbar navbar-default">
		  <div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="#">Logs report</a>
			</div>

			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				<ul class="nav navbar-nav">
					<li class="active"><a href="./index.html">Index</a></li>
					<li><a href="/_utils/">CouchDB Admin</a></li>
				</ul>
			</div>	
		  </div>	
		</nav>
		<div id="content">
			<div class="panel panel-primary">
				<div class="panel-heading">Participants</div>
				<div class="panel-body">
					<a class="btn btn-primary btn-lg" href="./user.html?key=">See all contributions</a>
					<div id="tagCloud"></div>
				</div>
			</div>
			<div class="panel panel-primary">
				<div class="panel-heading">Serveurs</div>
				<div class="panel-body">
					<div id="url" class="list-group">
					</div>
				</div>
			</div>
		</div>
	</body>
</html>